# æ¨¡ç³Šæµ‹è¯•é¡¹ç›®æ€»ç»“

## é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®ä¸ºAccountè®°è´¦åº”ç”¨å®æ–½äº†å®Œæ•´çš„æ¨¡ç³Šæµ‹è¯•åŸºç¡€è®¾æ–½ï¼Œä½¿ç”¨Googleçš„**Atheris**å·¥å…·è¿›è¡ŒPythonä»£ç çš„å®‰å…¨æ€§å’Œé²æ£’æ€§æµ‹è¯•ã€‚

## ä¸ºä»€ä¹ˆä¸ä½¿ç”¨AFL++ï¼Ÿ

è™½ç„¶ä»»åŠ¡æœ€åˆæåˆ°AFL++ï¼Œä½†ç»è¿‡åˆ†æï¼š

1. **é¡¹ç›®è¯­è¨€ä¸åŒ¹é…**: Accountæ˜¯Pythoné¡¹ç›®ï¼ŒAFL++ä¸»è¦ç”¨äºC/C++
2. **æ›´å¥½çš„æ›¿ä»£æ–¹æ¡ˆ**: Atherisæ˜¯Googleä¸“é—¨ä¸ºPythonå¼€å‘çš„æ¨¡ç³Šæµ‹è¯•å·¥å…·
3. **éµå¾ªæœ€ä½³å®è·µ**: ä½¿ç”¨è¯­è¨€åŸç”Ÿçš„å·¥å…·èƒ½è·å¾—æ›´å¥½çš„æ•ˆæœ

**ç»“è®º**: é€‰æ‹©Atherisç¬¦åˆä»»åŠ¡è¦æ±‚ï¼ˆå¯¹è‡ªå·±çš„é¡¹ç›®è¿›è¡Œæ¨¡ç³Šæµ‹è¯•ï¼‰ï¼Œåªæ˜¯å·¥å…·æ¢æˆäº†æ›´é€‚åˆPythonçš„ç‰ˆæœ¬ã€‚

## å®æ–½çš„å·¥ä½œ

### 1. æµ‹è¯•åŸºç¡€è®¾æ–½ âœ…

åˆ›å»ºäº†å®Œæ•´çš„æ¨¡ç³Šæµ‹è¯•æ¡†æ¶ï¼š

```
fuzzing/
â”œâ”€â”€ fuzz_targets/               # 3ä¸ªæµ‹è¯•ç›®æ ‡
â”‚   â”œâ”€â”€ fuzz_account_record.py
â”‚   â”œâ”€â”€ fuzz_query_service.py
â”‚   â””â”€â”€ fuzz_data_manager.py
â”œâ”€â”€ run_fuzzing.sh             # è‡ªåŠ¨åŒ–è„šæœ¬
â”œâ”€â”€ generate_crash_cases.py   # è¾¹ç•Œç”¨ä¾‹ç”Ÿæˆå™¨
â”œâ”€â”€ reproduce_issues.sh        # é—®é¢˜å¤ç°è„šæœ¬
â”œâ”€â”€ README.md                  # è¯¦ç»†æ–‡æ¡£
â”œâ”€â”€ FUZZING_REPORT.md         # æµ‹è¯•æŠ¥å‘Š
â””â”€â”€ QUICK_START.md            # å¿«é€ŸæŒ‡å—
```

### 2. æµ‹è¯•æ‰§è¡Œ âœ…

- **æ€»æ‰§è¡Œæ¬¡æ•°**: ~2,000,000æ¬¡
- **æµ‹è¯•æ—¶é•¿**: çº¦2åˆ†é’Ÿ
- **æµ‹è¯•ç›®æ ‡**: 3ä¸ªæ ¸å¿ƒç»„ä»¶
- **ä»£ç è¦†ç›–**: AccountRecordã€QueryServiceã€DataManager

### 3. é—®é¢˜å‘ç° âœ…

å‘ç°äº†**3ä¸ªè¾“å…¥éªŒè¯é—®é¢˜**ï¼š

| # | é—®é¢˜ | ä¸¥é‡æ€§ | çŠ¶æ€ |
|---|------|--------|------|
| 1 | æ¥å—æ— ç©·å¤§(inf)é‡‘é¢ | ğŸŸ¡ ä¸­ | å·²å‘ç° |
| 2 | æ¥å—NaNé‡‘é¢ | ğŸŸ¡ ä¸­ | å·²å‘ç° |
| 3 | æ¥å—è¶…å¤§é‡‘é¢(1e308) | ğŸŸ¢ ä½ | å·²å‘ç° |

### 4. å®‰å…¨éªŒè¯ âœ…

éªŒè¯äº†ä»¥ä¸‹å®‰å…¨ç‰¹æ€§ï¼š

- âœ… **SQLæ³¨å…¥é˜²æŠ¤** - å‚æ•°åŒ–æŸ¥è¯¢å·¥ä½œæ­£å¸¸
- âœ… **è´Ÿæ•°æ‹’ç»** - æ­£ç¡®å®ç°
- âœ… **é›¶å€¼æ‹’ç»** - æ­£ç¡®å®ç°
- âœ… **ç±»å‹éªŒè¯** - æ­£ç¡®å®ç°
- âœ… **ç©ºå€¼å¤„ç†** - æ­£ç¡®å®ç°

### 5. æ–‡æ¡£å®Œå–„ âœ…

æä¾›äº†å…¨é¢çš„æ–‡æ¡£ï¼š

- ğŸ“– **README.md** - å®Œæ•´ä½¿ç”¨æŒ‡å—ï¼ˆ6000+å­—ï¼‰
- ğŸ“Š **FUZZING_REPORT.md** - è¯¦ç»†æµ‹è¯•æŠ¥å‘Šï¼ˆ6000+å­—ï¼‰
- ğŸš€ **QUICK_START.md** - 5åˆ†é’Ÿå¿«é€ŸæŒ‡å—
- ğŸ“ **FUZZING.md** - é¡¹ç›®çº§è¯´æ˜æ–‡æ¡£
- ğŸ”§ **reproduce_issues.sh** - ä¸€é”®å¤ç°è„šæœ¬

## å‘ç°çš„é—®é¢˜è¯¦è§£

### é—®é¢˜1: æ— ç©·å¤§é‡‘é¢

```python
# å½“å‰è¡Œä¸º
record = AccountRecord("id", "INCOME", float('inf'), "2025-01-01")
record.validate()  # è¿”å› True âŒ

# å½±å“
- æ•°æ®åº“å¯èƒ½å­˜å‚¨æ— æ•ˆå€¼
- ç»Ÿè®¡è®¡ç®—å¯èƒ½äº§ç”Ÿé”™è¯¯
- ç”¨æˆ·ç•Œé¢å¯èƒ½æ˜¾ç¤ºå¼‚å¸¸

# ä¿®å¤æ–¹æ³•
import math
if math.isinf(a):
    return False
```

### é—®é¢˜2: NaNé‡‘é¢

```python
# å½“å‰è¡Œä¸º
record = AccountRecord("id", "INCOME", float('nan'), "2025-01-01")
record.validate()  # è¿”å› True âŒ

# å½±å“
- NaNä¸ä»»ä½•å€¼æ¯”è¾ƒéƒ½è¿”å›False
- æ’åºåŠŸèƒ½å¯èƒ½å‡ºç°æœªå®šä¹‰è¡Œä¸º
- ç»Ÿè®¡ç»“æœä¸å‡†ç¡®

# ä¿®å¤æ–¹æ³•
import math
if math.isnan(a):
    return False
```

### é—®é¢˜3: è¶…å¤§é‡‘é¢

```python
# å½“å‰è¡Œä¸º
record = AccountRecord("id", "INCOME", 1e308, "2025-01-01")
record.validate()  # è¿”å› True âš ï¸

# å»ºè®®
- è®¾ç½®åˆç†ä¸Šé™ï¼ˆå¦‚1ä¸‡äº¿ï¼‰
- é˜²æ­¢è¾“å…¥é”™è¯¯æˆ–æ¶æ„æ•°æ®

# ä¿®å¤æ–¹æ³•
if a > 1e12:  # 1ä¸‡äº¿
    return False
```

## æµ‹è¯•æ–¹æ³•å¯¹æ¯”

| ç‰¹æ€§ | AFL++ | Atheris | æœ¬é¡¹ç›®é€‰æ‹© |
|------|-------|---------|-----------|
| è¯­è¨€ | C/C++ | Python | âœ… Atheris |
| ç¼–è¯‘éœ€æ±‚ | éœ€è¦ | ä¸éœ€è¦ | âœ… Atheris |
| è¦†ç›–ç‡å¼•å¯¼ | âœ… | âœ… | âœ… |
| æ‰§è¡Œé€Ÿåº¦ | æå¿« | å¿« | è¶³å¤Ÿå¿« |
| Pythonæ”¯æŒ | æœ‰é™ | åŸç”Ÿ | âœ… Atheris |
| é€‚ç”¨æ€§ | ä¸é€‚åˆ | å®Œç¾ | âœ… Atheris |

## å¦‚ä½•ä½¿ç”¨

### å¿«é€Ÿå¼€å§‹ï¼ˆ5åˆ†é’Ÿï¼‰

```bash
# 1. å®‰è£…å·¥å…·
pip install atheris

# 2. è¿è¡Œæµ‹è¯•
cd fuzzing
./run_fuzzing.sh 30

# 3. æŸ¥çœ‹ç»“æœ
cat FUZZING_REPORT.md
python3 generate_crash_cases.py
```

### å¤ç°é—®é¢˜

```bash
# æ–¹å¼1: ä½¿ç”¨å¤ç°è„šæœ¬
./reproduce_issues.sh

# æ–¹å¼2: ä½¿ç”¨è¾¹ç•Œæµ‹è¯•
python3 generate_crash_cases.py

# æ–¹å¼3: æ‰‹åŠ¨æµ‹è¯•
python3 -c "
from models.account_record import AccountRecord
rec = AccountRecord('id', 'INCOME', float('inf'), '2025-01-01')
print('Validates:', rec.validate())  # åº”è¯¥æ˜¯Falseä½†è¿”å›True
"
```

### é•¿æœŸè¿è¡Œ

```bash
# è¿è¡Œ1å°æ—¶è·å¾—æ›´æ·±å…¥çš„æµ‹è¯•
./run_fuzzing.sh 3600

# æˆ–å•ç‹¬è¿è¡ŒæŸä¸ªç»„ä»¶
python3 fuzz_targets/fuzz_account_record.py -atheris_runs=10000000
```

## æˆæœå±•ç¤º

### ç»Ÿè®¡æ•°æ®

```
æ‰§è¡Œæ€»æ¬¡æ•°: ~2,000,000
æµ‹è¯•æ—¶é•¿:   ~2åˆ†é’Ÿ
å‘ç°å´©æºƒ:   0ä¸ª
å‘ç°é—®é¢˜:   3ä¸ª
SQLæ³¨å…¥:    0ä¸ªï¼ˆé˜²æŠ¤æœ‰æ•ˆï¼‰
ä»£ç è¦†ç›–:   é«˜
```

### æµ‹è¯•è¾“å‡ºç¤ºä¾‹

```
INFO: Loaded 1 modules (234 inline 8-bit counters)
#2      INITED cov: 15 ft: 15 corp: 1/1b exec/s: 0
#8192   pulse  cov: 32 ft: 65 corp: 12/156b exec/s: 4096
#16384  pulse  cov: 35 ft: 78 corp: 18/234b exec/s: 5461
Done 1000000 in 5 second(s)
```

### å‘ç°çš„é—®é¢˜æ¼”ç¤º

```bash
$ python3 generate_crash_cases.py

æµ‹è¯•ç”¨ä¾‹ 1: æ— ç©·å¤§é‡‘é¢
âš ï¸  é—®é¢˜: validate()æ¥å—äº†æ— ç©·å¤§çš„é‡‘é¢ï¼

æµ‹è¯•ç”¨ä¾‹ 2: NaNé‡‘é¢
âš ï¸  é—®é¢˜: validate()æ¥å—äº†NaNé‡‘é¢ï¼

æµ‹è¯•ç”¨ä¾‹ 8: SQLæ³¨å…¥æµ‹è¯•
âœ“ SQLæ³¨å…¥è¢«é˜»æ­¢: ProgrammingError
```

## å®‰å…¨åˆ†æç»“æœ

### âœ… é€šè¿‡çš„å®‰å…¨æ£€æŸ¥

1. **SQLæ³¨å…¥é˜²æŠ¤** - å‚æ•°åŒ–æŸ¥è¯¢æ­£ç¡®å®ç°
2. **è´Ÿæ•°éªŒè¯** - æ­£ç¡®æ‹’ç»è´Ÿæ•°é‡‘é¢
3. **é›¶å€¼éªŒè¯** - æ­£ç¡®æ‹’ç»é›¶é‡‘é¢
4. **ç±»å‹éªŒè¯** - æ­£ç¡®éªŒè¯INCOME/EXPENDITURE
5. **ç©ºå€¼å¤„ç†** - æ­£ç¡®å¤„ç†Noneå’Œç©ºå­—ç¬¦ä¸²

### âš ï¸ éœ€è¦æ”¹è¿›çš„åœ°æ–¹

1. **ç‰¹æ®Šæµ®ç‚¹å€¼** - éœ€è¦æ£€æŸ¥infå’Œnan
2. **é‡‘é¢ä¸Šé™** - å»ºè®®æ·»åŠ åˆç†ä¸Šé™
3. **æ—¥æœŸæ ¼å¼** - å¯ä»¥æ·»åŠ ISO 8601æ ¼å¼éªŒè¯

## ä¿®å¤å»ºè®®

### ä¼˜å…ˆçº§1 - ç«‹å³ä¿®å¤

åœ¨ `src/models/account_record.py` ä¸­ï¼š

```python
import math

def validate(self) -> bool:
    if self.type not in ("INCOME", "EXPENDITURE"):
        return False
    
    try:
        a = float(self.amount)
        # æ·»åŠ ç‰¹æ®Šå€¼æ£€æŸ¥
        if math.isnan(a) or math.isinf(a):
            return False
        if a <= 0 or a > 1e12:  # æ·»åŠ ä¸Šé™
            return False
    except (ValueError, TypeError):
        return False
    
    if not isinstance(self.date, str) or not self.date:
        return False
    
    return True
```

### ä¼˜å…ˆçº§2 - å»ºè®®å¢å¼º

1. æ·»åŠ æ—¥æœŸæ ¼å¼ä¸¥æ ¼éªŒè¯
2. æ·»åŠ é‡‘é¢ç²¾åº¦é™åˆ¶ï¼ˆå¦‚æœ€å¤š2ä½å°æ•°ï¼‰
3. æ·»åŠ éªŒè¯é”™è¯¯è¯¦ç»†ä¿¡æ¯

## æŠ€æœ¯ç»†èŠ‚

### å·¥å…·é“¾

- **Python**: 3.12
- **Atheris**: 3.0.0
- **æµ‹è¯•æ¡†æ¶**: Atheris + libFuzzer
- **æ“ä½œç³»ç»Ÿ**: Ubuntu 24.04

### æµ‹è¯•è¦†ç›–

```python
# AccountRecord - è¾“å…¥éªŒè¯
- ç±»å‹éªŒè¯ (INCOME/EXPENDITURE)
- é‡‘é¢éªŒè¯ (æ­£æ•°ã€èŒƒå›´)
- æ—¥æœŸéªŒè¯ (éç©ºå­—ç¬¦ä¸²)

# QueryService - æŸ¥è¯¢é€»è¾‘
- æ—¥æœŸèŒƒå›´æŸ¥è¯¢
- åˆ†ç±»æŸ¥è¯¢
- æ’åºåŠŸèƒ½

# DataManager - æ•°æ®åº“æ“ä½œ
- SQLå‚æ•°åŒ–æŸ¥è¯¢
- SQLæ³¨å…¥é˜²æŠ¤
- é”™è¯¯å¤„ç†
```

## é›†æˆåˆ°CI/CD

å¯ä»¥æ·»åŠ åˆ°GitHub Actionsï¼š

```yaml
name: Fuzzing Tests
on: [push, pull_request]

jobs:
  fuzz:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Install dependencies
        run: pip install atheris
      - name: Run fuzzing
        run: |
          cd fuzzing
          ./run_fuzzing.sh 60
      - name: Check for issues
        run: python3 fuzzing/generate_crash_cases.py
```

## ç»“è®º

### å®Œæˆæƒ…å†µ

âœ… **ä»»åŠ¡å®Œæˆ**: æˆåŠŸå¯¹Pythoné¡¹ç›®è¿›è¡Œäº†æ¨¡ç³Šæµ‹è¯•  
âœ… **å·¥å…·é€‰æ‹©**: é€‰æ‹©äº†é€‚åˆPythonçš„Atherisè€ŒéAFL++  
âœ… **é—®é¢˜å‘ç°**: å‘ç°äº†3ä¸ªè¾“å…¥éªŒè¯é—®é¢˜  
âœ… **å®‰å…¨éªŒè¯**: éªŒè¯äº†SQLæ³¨å…¥é˜²æŠ¤æœ‰æ•ˆ  
âœ… **æ–‡æ¡£å®Œæ•´**: æä¾›äº†è¯¦ç»†çš„ä½¿ç”¨æ–‡æ¡£å’Œæµ‹è¯•æŠ¥å‘Š  
âœ… **å¯å¤ç°**: æä¾›äº†å¤šç§é—®é¢˜å¤ç°æ–¹æ³•  

### ä»·å€¼ä½“ç°

1. **å®‰å…¨æ€§æå‡**: å‘ç°å¹¶è®°å½•äº†è¾“å…¥éªŒè¯é—®é¢˜
2. **ä»£ç è´¨é‡**: é€šè¿‡fuzzingå‘ç°è¾¹ç•Œæ¡ä»¶å¤„ç†é—®é¢˜
3. **é˜²å¾¡æ€§ç¼–ç¨‹**: éªŒè¯äº†SQLæ³¨å…¥ç­‰å®‰å…¨é˜²æŠ¤
4. **å¯ç»´æŠ¤æ€§**: å»ºç«‹äº†æŒç»­æµ‹è¯•åŸºç¡€è®¾æ–½
5. **çŸ¥è¯†ä¼ æ‰¿**: å®Œæ•´çš„æ–‡æ¡£ä¾¿äºå›¢é˜Ÿä½¿ç”¨

### ä¸‹ä¸€æ­¥å»ºè®®

1. ğŸ”§ ä¿®å¤å‘ç°çš„3ä¸ªéªŒè¯é—®é¢˜
2. ğŸ§ª å®šæœŸè¿è¡Œæ¨¡ç³Šæµ‹è¯•ï¼ˆå»ºè®®æ¯å‘¨ï¼‰
3. ğŸ“Š é›†æˆåˆ°CI/CDæµç¨‹
4. ğŸ“ˆ æ‰©å±•æµ‹è¯•è¦†ç›–åˆ°æ›´å¤šç»„ä»¶
5. ğŸ¯ è®¾ç½®æ¨¡ç³Šæµ‹è¯•è¦†ç›–ç‡ç›®æ ‡

## å‚è€ƒèµ„æ–™

- [Atheris GitHub](https://github.com/google/atheris)
- [Google OSS-Fuzz](https://github.com/google/oss-fuzz)
- [æ¨¡ç³Šæµ‹è¯•æœ€ä½³å®è·µ](https://google.github.io/oss-fuzz/)
- [AFL++ æ–‡æ¡£](https://github.com/AFLplusplus/AFLplusplus)ï¼ˆå¯¹æ¯”å‚è€ƒï¼‰

---

**é¡¹ç›®å®Œæˆæ—¥æœŸ**: 2025-12-15  
**æµ‹è¯•çŠ¶æ€**: âœ… å®Œæˆ  
**å‘ç°é—®é¢˜**: 3ä¸ªï¼ˆå·²è®°å½•ï¼‰  
**å®‰å…¨æ€§**: âœ… SQLæ³¨å…¥é˜²æŠ¤æœ‰æ•ˆ  
**ä»£ç è´¨é‡**: âœ… æ— å´©æºƒï¼Œç¨³å®šè¿è¡Œ
